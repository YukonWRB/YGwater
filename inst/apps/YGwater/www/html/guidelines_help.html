<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Guideline SQL — Help</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  body { margin: 2rem auto; max-width: 1500px; font: 16px/1.5 system-ui, sans-serif; }
  h1,h2,h3 { margin-top: 1.5rem; }
  code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  pre { background: #f6f8fa; padding: 1rem; overflow: auto; border-radius: 8px; }
  .tip { background: #eef6ff; padding: .75rem 1rem; border-left: 4px solid #6aaefc; border-radius: 6px; }

  /* Table styling */
  table {
    border-collapse: collapse;
    width: 100%;
    margin: 1rem 0;
  }
  th, td {
    border: 1px solid #ccc;   /* vertical + horizontal lines */
    padding: 0.5rem 0.75rem;
    text-align: left;
  }
  th {
    background: #f2f2f2;
  }
  thead tr {
    border-bottom: 2px solid #999; /* stronger separator under header */
  }
  code {
  font-size: 1em;   /* targets in-line code */
  }
   /* Improve readability for code inside table cells */
  table pre {
    white-space: pre-wrap;     /* allow wrapping */
    word-break: break-word;    /* break long tokens */
  }
  table pre code {
  font-size: 0.8em;   /* smaller than normal */
  line-height: 1;   /* tighten vertical spacing */
  }

</style>

</head>
<body>
  <h1>How to Enter a New Guideline</h1>
  <h3>(Or edit an existing one)</h3>
  <br>
  <h2>Guideline storage and retrieval in AquaCache</h2>
  <p>Guidelines are stored in the database formatted as standard SQL language, and stored in a table along with information such as the guideline name, the organization it was issued by, the parameter it pertains to, and whether that parameter is total, dissolved, etc.</p>
  <p>Simple, fixed guidelines and calculation-based guidelines are stored in the same table, and both leverage SQL language to return their value directly from the database. This storage system makes it simple to select the guideline you want and ensures that all guidelines are called in the same way regardless of their derivation process.</p>
  <p>Here is a simplified example of guideline storage:</p>

<table>
  <thead>
  <tr>
    <th>id</th>
    <th>name</th>
    <th>organization</th>
    <th>parameter</th>
    <th>fraction</th>
    <th>guideline SQL</th>
  </tr>
  </thead>
  <tbody>
  <tr>
  <td>1</td>
    <td>Arsenic, long term, PAL, freshwater</td>
    <td>CCME</td>
    <td>Arsenic</td>
    <td>Dissolved</td>
    <td>
    <pre><code>SELECT 0.005::numeric</code></pre>
    <i>Returns 0.005 mg/l (database units) = 5 ug/l</i>
    </td>
  </tr>
  <tr>
  <td>2</td>
  <td>Aluminium, long term, PAL, freshwater</td>
  <td>CCME</td>
  <td>Aluminium</td>
  <td>Dissolved</td>
  <td>
    <pre><code>WITH ph AS (
  SELECT MAX(result) AS ph FROM results
  WHERE {parameter} = {pH} AND {sample} = {sample_id}
)
SELECT CASE
  WHEN ph &lt; 6.5 THEN 0.005::numeric
  ELSE               0.1::numeric
END
FROM ph;</code></pre>
    <i>Fetches pH for the target sample and returns the appropriate value (database units of mg/l). Note that the { } denote placeholders for reading convenience here - the true SQL contains numeric ids.</i>
  </td>
</tr>
  </tbody>
</table>

<p>Guidelines are retrieved by querying the 'guidelines' table directly, filtering on any of the table columns; evaluation is done by processing the SQL code in the database using a custom function, <code>get_guideline_value(guideline_id, sample_id)</code>. This setup has several benefits:</p>
<ul>
  <li>Guideline calculation are completely independent of the software used to call them.</li>
  <ul>
    <li>Each application gets the same result, no matter what.</li>
    <li>Scripts are created once, edited in a single place, and held in a standardized container.</li>
  </ul>
  <li>Simple and calculated guidelines are stored together and retrieved using the same process, simplifying usage.</li>
  <li>Calculated guideline application only requires a sample id and auto-fetches relevant sample results.</li>
  <li>It leverages the evaluation speed of SQL language and further improves calculation speed by performing fetch operations in database.</li>
</ul>

  <br>
  
  <h2>Adding guidelines</h2>
  <p>Guidelines can be added or modified in the database by directly editing the 'discrete.guidelines' table - either using R, Python, or an interactive database explorer - or via a purpose-built module in the YGwater Shiny application. Strict database checks are applied for any new entries or edits to existing entries to ensure that:</p>
  
  <li>You can only reference existing parameters and sample fractions</li>
  <li>No two guidelines exist for the same parameter/fraction/organization/name combination</li>
  <li>The SQL you enter is safe to run and returns only a single value</li>
  <li>The SQL only references allowed schemas and tables.</li>
  
  <h3>General Rules</h3>
  <ul>
    <li>Start with <code>SELECT</code> (or <code>WITH … SELECT</code>).</li>
    <li>Return exactly one numeric value (e.g., <code>SELECT 0.05::numeric</code> or <code>SELECT 0.05</code></li>
    <li>For calculated guidelines that require a sample_id to select results for calculations, use <code>$1</code> as a placeholder for the sample_id.  You'll populated that when calling the function so that it can work with any sample.</li>
    <li>If you use <code>$1</code> (the <em>sample_id</em>), you <strong>must cast it as an integer</strong> (e.g., <code>$1::integer</code>).</li>
    <li>No semicolons or data-modifying statements are allowed.</li>
    <li>Proper SQL syntax must be used (enforced by a check function)</li>
  </ul>
  
  <h3>Examples</h3>
  <h4>Sample-Independent (<a href="https://ccme.ca/en/chemical/225">CCME PAL long term for uranium</a>)</h4>
  <pre><code>SELECT 0.015::numeric</code></pre>
  <p>This very simple guideline returns a fixed value, 0.015; units should be the database standard units for the relevant parameter. Of course, since the database entry (record) for this SQL statement is on a common row with the target parameter_id, we can find out the target parameter and its units by consulting the 'parameters' table. Note that there is no dependency here on a sample_id!</p>

  <h4>Sample-Dependent (<a href="https://ccme.ca/en/chemical/71">CCME PAL long term for copper</a>)</h4>
  
  <p>Note: it's better (and called for in some guideline documents) to calculate hardness from calcium and magnesium concentrations rather than use the reported hardness. This bypasses the ambiguity in how hardness is often reported, since that value varies according to the methodology used. Hardness is still coded in as a backup in case either calcium or magnesium concentrations are missing.</p>
  
  <pre><code>WITH vals AS (
  SELECT
    -- dissolved Ca/Mg (preferred)
    MAX(result) FILTER (WHERE parameter_id = 1061 AND sample_fraction_id = 19) AS ca_d, -- calcium dissolved
    MAX(result) FILTER (WHERE parameter_id = 1103 AND sample_fraction_id = 19) AS mg_d, -- magnesium dissolved
    -- reported dissolved hardness (as CaCO3 - fallback 1)
    MAX(result) FILTER (WHERE parameter_id = 100  AND sample_fraction_id = 19 AND result_speciation_id = 3) AS hard_d, -- hardness dissolved as CaCO3
    -- total Ca/Mg (fallback 2)
    MAX(result) FILTER (WHERE parameter_id = 1061 AND sample_fraction_id = 5)  AS ca_t, -- calcium total
    MAX(result) FILTER (WHERE parameter_id = 1103 AND sample_fraction_id = 5)  AS mg_t, -- magnesium total
    -- reported total hardness (fallback 3)
    MAX(result) FILTER (WHERE parameter_id = 100  AND sample_fraction_id = 5 AND result_speciation_id = 3)  AS hard_t -- hardness total as CaCO3
  FROM discrete.results
  WHERE sample_id = $1::integer
),
hardness AS (
  -- Compute hardness as CaCO3 (mg/L) where possible; otherwise use reported hardness
  SELECT CASE
    WHEN ca_d IS NOT NULL AND mg_d IS NOT NULL AND ca_d > 0 AND mg_d > 0
      THEN 2.497*ca_d + 4.118*mg_d
    WHEN hard_d IS NOT NULL AND hard_d > 0
      THEN hard_d
    WHEN ca_t IS NOT NULL AND mg_t IS NOT NULL AND ca_t > 0 AND mg_t > 0
      THEN 2.497*ca_t + 4.118*mg_t
    WHEN hard_t IS NOT NULL AND hard_t > 0
      THEN hard_t
    ELSE NULL
  END AS h
  FROM vals
)
-- Return Copper CWQG in mg/L (convert µg/L thresholds by /1000)
SELECT CASE
  WHEN h IS NULL OR h < 82
    THEN 0.002::numeric                          -- 2 µg/L, the minimum and fallback value
  WHEN h <= 180
    THEN (0.2 * exp(0.8545*ln(h) - 1.465) / 1000)::numeric  -- convert µg/L → mg/L
  ELSE
    0.004::numeric                          -- 4 µg/L, the maximum value which is only ever valid if the calculations could be run
END
FROM hardness;
</code></pre>

<p>This (much) more complex guideline can be broken down into three parts:
<ol>
<li>The <code>WITH vals AS (...)</code> portion fetches results from the database's 'discrete.results' table</li>
<li>The <code>hardness AS (...)</code> portion calculates the hardness using the preferred, descending order of variables.</li>
<li>The final <code>SELECT CASE ...</code> portion returns the appropriate guideline value based on the calculated hardness OR a fallback value if hardness could not be calculated.</li>
</ol>
<p>There are several things of note:</p>
<ul>
<li>Parameters are referenced by their parameter_ids</li>
<li>Sample fractions are referenced by their sample_fraction_idss</li>
<li>The sample_id is passed in as <code>$1</code> and cast to an integer</li>
<li>The SQL returns a single numeric value, explicitly cast as numeric.</li>
<li>The returned value is converted to mg/l to align with database units for copper.</li>
</ul>

<h3>Secret sauce for generating calculated guideline SQL</h3>

<p>
It can seem daunting to translate CCME (or other) guidelines into SQL, but you don’t have to start from scratch. 
Large Language Models (LLMs) like ChatGPT can generate valid SQL if you give them the right instructions. 
Below is a “prompt template” you can use when asking an LLM to draft guideline SQL for this database.
</p>

<h4>What the LLM needs to know</h4>
<ul>
  <li><strong>Goal:</strong> Write one PostgreSQL <code>SELECT</code> (or <code>WITH … SELECT</code>) that returns a single numeric guideline in <em>mg/L</em>.</li>
  <li><strong>Sample filtering:</strong> Use <code>WHERE sample_id = $1::integer</code> when results depend on a sample.</li>
  <li><strong>Constraints:</strong>
    <ul>
      <li>One statement only, no semicolons, no data modification.</li>
      <li>Return exactly one numeric value, explicitly cast with <code>::numeric</code>.</li>
      <li>Only allowed schemas: <code>discrete</code>, <code>public</code>.</li>
    </ul>
  </li>
  <li><strong>Hardness calculations (mg/L as CaCO₃):</strong> 
    <code>2.497*Ca + 4.118*Mg</code>.
    <br/>Use this order of preference:
    <ol>
      <li>Dissolved Ca + Mg</li>
      <li>Reported dissolved hardness</li>
      <li>Total Ca + Mg </li>
      <li>Reported total hardness</li>
    </ol>
  </li>
  <li><strong>Parameter IDs (adjust for your needs):</strong>
    Calcium = 1061, Magnesium = 1103, Hardness as CaCO₃ = 100.  
  </li>
  <li><strong>Sample fractions (adjust for your needs):</strong>
  Dissolved = 19, Total = 5.
  </li>
  <li><strong>Units:</strong> The returned guideline must be in mg/L <strong>(Adjust for your needs)</strong>. If the published formula is in µg/L, divide by 1000.</li>
</ul>

<h4>Prompt template</h4>
<pre><code>Write a single PostgreSQL SELECT (or WITH … SELECT) that returns one numeric guideline value 
in mg/L for a given sample_id.

Constraints you MUST follow:
- Use WHERE sample_id = $1::integer (cast required).
- One statement only, no semicolons, no data modification.
- Return exactly one numeric.
- Prefer calculating hardness (as CaCO3, mg/L) from dissolved Ca and Mg:
  hardness = 2.497*Ca + 4.118*Mg
  Use dissolved first, else reported dissolved Hardness, else total Ca+Mg (fraction_id=5), 
  else reported total Hardness.
- The returned value MUST be in mg/L.
- Relevant IDs: <strong>ADJUST FOR YOUR NEEDS</strong> Calcium=1061, Magnesium=1103, Hardness=100; 
- Relevant fractions: <strong>ADJUST FOR YOUR NEEDS</strong> Dissolved=19, Total=5.

Return an SQL statement that computes the guideline for 
<strong>[insert the guideline description or formula here]</strong>
</code></pre>

<p>
👉 With this context, an LLM can usually draft valid guideline SQL. Always review the SQL for accuracy and  test the generated query against real data.
</p>
  <div class="tip"><strong>Tip:</strong> If you enter guidelines using the Shiny application, make use of the helper buttons to insert your desired parameters and sample fractions into the SQL text</div>

</body>
</html>
